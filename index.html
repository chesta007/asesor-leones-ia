<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Asesor P√∫blico Digital | Noticias</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Estilos b√°sicos */
        body { font-family: sans-serif; background-color: #f4f4f9; color: #333; line-height: 1.6; padding: 20px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: background 0.3s; }
        h1 { color: #10b981; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 20px; color: #333; }
        .category { margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; border-radius: 6px; }
        .category p { white-space: pre-wrap; }
        #metadata { font-size: 0.9em; color: #888; margin-bottom: 20px; }
        
        /* Botones y Contador Global (solo Vistas) */
        .engagement-bar { margin-top: 30px; padding-top: 15px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        #view-counter { font-size: 1.2em; font-weight: bold; }

        /* üü¢ NUEVOS ESTILOS PARA VOTOS POR CATEGOR√çA */
        .category-engagement-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: 10px; 
            padding-top: 5px; 
            border-top: 1px dashed #eee;
            font-size: 0.9em;
        }
        .category-engagement-bar button { 
            padding: 5px 10px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-left: 5px; 
            font-weight: bold; 
        }
        .category-engagement-bar .like { background-color: #10b981; color: white; }
        .category-engagement-bar .dislike { background-color: #ef4444; color: white; }
        
        /* Estilos de Modo Oscuro */
        .dark-mode { background-color: #1c1c1c; color: #f4f4f9; }
        .dark-mode .container { background: #2c2c2c; box-shadow: none; }
        .dark-mode h1, .dark-mode h2 { color: #10b981; }
        .dark-mode .category { border-color: #444; }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="main-title">Cargando Informe Local...</h1>
        <p id="metadata">Fecha: -- | Actualizado: --</p>
        
        <div id="report-content">
            <p>Conectando con la base de datos de Gemini...</p>
        </div>

        <div class="engagement-bar">
            <div id="view-counter"><i class="fas fa-eye"></i> Vistas: 0</div>
            <div>
                <button onclick="toggleDarkMode()"><i class="fas fa-moon"></i> Modo Oscuro</button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuraci√≥n (P√öBLICA) ---
        const FIREBASE_CONFIG = { 
            apiKey: "AIzaSyAPPXz2z0Eo72Sa9nIdwzvr7oVxOQpFs5w", 
            databaseURL: "https://proyecto-asesor-publico-default-rtdb.firebaseio.com", 
        };
        const BASE_CIUDAD_PATH = 'PAISES/argentina/provincias/cordoba/ciudades/';

        // Inicializaci√≥n de Firebase con la versi√≥n estable
        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.database();

        let currentLocalityId = 'leones'; 
        const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        
        // Estado de voto por categor√≠a guardado en sessionStorage
        let userVoteState = {}; 

        // 1. OBTENER ID DE LOCALIDAD DE LA URL
        function getLocalityIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            currentLocalityId = params.get('localidad') || 'leones';
        }
        
        // 2. REGISTRO DE VISITAS Y LECTURA DE CONTADOR
        function registerView() {
            const viewPath = `${BASE_CIUDAD_PATH}${currentLocalityId}/views/${today}/total`;
            
            // 2.1. Lee el contador (para mostrarlo)
            db.ref(viewPath).on('value', snap => {
                document.getElementById('view-counter').innerHTML = `<i class="fas fa-eye"></i> Vistas: ${snap.val() ? snap.val().toLocaleString() : 0}`;
            });

            // 2.2. Registra la visita (solo si es la primera vez en esta sesi√≥n)
            if (!sessionStorage.getItem('viewRegistered')) {
                db.ref(viewPath).transaction((currentTotal) => {
                    return (currentTotal || 0) + 1;
                });
                sessionStorage.setItem('viewRegistered', 'true');
            }
        }
        
        // üü¢ 3. NUEVA FUNCI√ìN: ENV√çO DE VOTO POR CATEGOR√çA
        function sendCategoryVote(categoryId, type) {
            // Control de voto √∫nico por sesi√≥n y categor√≠a
            if (sessionStorage.getItem(`vote_${categoryId}_${today}`)) {
                alert(`Ya has votado (${sessionStorage.getItem('vote_' + categoryId + '_' + today)}) en esta categor√≠a hoy.`);
                return;
            }

            const userVoteKey = new Date().getTime(); 
            // üü¢ NUEVA RUTA: Agrega la fecha y el ID de la categor√≠a
            const votePath = `${BASE_CIUDAD_PATH}${currentLocalityId}/votes/${today}/${categoryId}/${userVoteKey}`;
            
            db.ref(votePath).set({
                type: type,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                alert(`‚úÖ Voto de ${type} registrado con √©xito para la categor√≠a "${categoryId}".`);
                sessionStorage.setItem(`vote_${categoryId}_${today}`, type); // Guarda el voto en la sesi√≥n
                loadCategoryVotes(categoryId); // Actualiza el contador
            })
            .catch(error => {
                console.error("Error al registrar voto:", error);
                alert(`‚ùå Error al registrar voto. Verifica las reglas de Firebase.`);
            });
        }
        
        // üü¢ 4. NUEVA FUNCI√ìN: CARGAR CONTEO DE VOTOS POR CATEGOR√çA
        function loadCategoryVotes(categoryId) {
            // Ruta para escuchar los cambios en los votos de la categor√≠a de hoy
            const votesRef = db.ref(`${BASE_CIUDAD_PATH}${currentLocalityId}/votes/${today}/${categoryId}`);
            
            votesRef.on('value', snapshot => {
                const votes = snapshot.val();
                let likeCount = 0;
                let dislikeCount = 0;
                
                if (votes) {
                    Object.values(votes).forEach(vote => {
                        if (vote.type === 'like') {
                            likeCount++;
                        } else if (vote.type === 'dislike') {
                            dislikeCount++;
                        }
                    });
                }
                
                const element = document.getElementById(`vote-count-${categoryId}`);
                if(element) {
                   element.innerHTML = `<i class="fas fa-thumbs-up"></i> ${likeCount} | <i class="fas fa-thumbs-down"></i> ${dislikeCount}`;
                }
            });
        }
        
        // 5. MODO OSCURO
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }


        // 6. CARGA DE DATOS PRINCIPAL (MODIFICADA)
        async function loadReport() {
            getLocalityIdFromUrl();
            document.getElementById('page-title').textContent = `Asesor P√∫blico | ${currentLocalityId.replace('_', ' ').toUpperCase()}`;
            
            const reportContentDiv = document.getElementById('report-content');

            try {
                // Leer el JSON generado por el robot
                const response = await fetch(`noticias_${currentLocalityId}.json?t=${new Date().getTime()}`);
                
                if (!response.ok) {
                    throw new Error("El informe no se ha generado o el archivo JSON no existe (404).");
                }
                
                const data = await response.json();

                if (!data || !data.categorias) {
                    throw new Error("Estructura de informe inv√°lida o vac√≠a.");
                }

                // 6.1 Renderizar T√≠tulo y Metadata
                document.getElementById('main-title').textContent = data.title;
                document.getElementById('metadata').textContent = `Actualizado: ${new Date(data.last_updated).toLocaleString()}`;

                // 6.2 Renderizar Categor√≠as (con botones de voto)
                let html = '';
                let categoriesToLoadVotes = []; 
                
                data.categorias.forEach(cat => {
                    // Genera un ID limpio para usar en Firebase y HTML
                    const categoryId = cat.nombre.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase(); 
                    categoriesToLoadVotes.push(categoryId); 
                    
                    html += `
                        <div class="category">
                            <h2>${cat.nombre}</h2>
                            <p>${cat.contenido}</p>
                            <div class="category-engagement-bar">
                                <div id="vote-count-${categoryId}">
                                    <i class="fas fa-thumbs-up"></i> 0 | <i class="fas fa-thumbs-down"></i> 0
                                </div>
                                <div>
                                    <button class="like" onclick="sendCategoryVote('${categoryId}', 'like')">üëç Me Gusta</button>
                                    <button class="dislike" onclick="sendCategoryVote('${categoryId}', 'dislike')">üëé No Me Gusta</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                reportContentDiv.innerHTML = html;
                
                registerView(); // Llama a registrar y monitorear vistas (sin cambios)
                
                // 6.3 Cargar los contadores de votos para cada categor√≠a
                categoriesToLoadVotes.forEach(loadCategoryVotes);
                
            } catch (error) {
                console.error("Error al cargar el informe:", error);
                reportContentDiv.innerHTML = `<p style="color:red;">‚ùå Error al cargar el informe para **${currentLocalityId.toUpperCase()}**. Causa: ${error.message || 'Error de conexi√≥n o JSON mal formado'}.<br> Ejecuta el robot desde el Dashboard y verifica la consola (F12).</p>`;
            }
        }

        // Inicia la aplicaci√≥n al cargar
        window.onload = loadReport;
    </script>
</body>
</html>
