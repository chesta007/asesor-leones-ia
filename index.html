<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Asesor P√∫blico Digital | Noticias</title>
    
    <script src="[https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js](https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js)"></script>
    <script src="[https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js](https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js)"></script>
    <script src="[https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js](https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js)"></script>
    <link rel="stylesheet" href="[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css](https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css)">

    <style>
        /* Estilos b√°sicos */
        body { font-family: sans-serif; background-color: #f4f4f9; color: #333; line-height: 1.6; padding: 20px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: background 0.3s; }
        h1 { color: #10b981; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 20px; color: #333; }
        .category { margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; border-radius: 6px; }
        .category p { white-space: pre-wrap; }
        #metadata { font-size: 0.9em; color: #888; margin-bottom: 20px; }
        
        /* Botones y Contador */
        .engagement-bar { margin-top: 30px; padding-top: 15px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .engagement-bar button { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; font-weight: bold; }
        .engagement-bar .like { background-color: #10b981; color: white; }
        .engagement-bar .dislike { background-color: #ef4444; color: white; }
        #view-counter { font-size: 1.2em; font-weight: bold; }
        
        /* üü¢ Estilos de Modo Oscuro */
        .dark-mode { background-color: #1c1c1c; color: #f4f4f9; }
        .dark-mode .container { background: #2c2c2c; box-shadow: none; }
        .dark-mode h1, .dark-mode h2 { color: #10b981; }
        .dark-mode .category { border-color: #444; }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="main-title">Cargando Informe Local...</h1>
        <p id="metadata">Fecha: -- | Actualizado: --</p>
        
        <div id="report-content">
            <p>Conectando con la base de datos de Gemini...</p>
        </div>

        <div class="engagement-bar">
            <div id="view-counter"><i class="fas fa-eye"></i> Vistas: 0</div>
            <div>
                <button class="like" onclick="sendVote('like')">üëç Me Gusta</button>
                <button class="dislike" onclick="sendVote('dislike')">üëé No Me Gusta</button>
                <button onclick="toggleDarkMode()"><i class="fas fa-moon"></i> Modo Oscuro</button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuraci√≥n (P√öBLICA) ---
        const FIREBASE_CONFIG = { 
            apiKey: "AIzaSyAPPXz2z0Eo72Sa9nIdwzvr7oVxOQpFs5w", 
            databaseURL: "[https://proyecto-asesor-publico-default-rtdb.firebaseio.com](https://proyecto-asesor-publico-default-rtdb.firebaseio.com)", 
        };
        const BASE_CIUDAD_PATH = 'PAISES/argentina/provincias/cordoba/ciudades/';

        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.database();

        let currentLocalityId = 'leones'; 
        let userVoteKey = null; 
        let userVoteState = null; // Para control de voto

        // 1. OBTENER ID DE LOCALIDAD DE LA URL
        function getLocalityIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            currentLocalityId = params.get('localidad') || 'leones';
        }
        
        // 2. REGISTRO DE VISITAS Y LECTURA DE CONTADOR
        function registerView() {
            const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const viewPath = `${BASE_CIUDAD_PATH}${currentLocalityId}/views/${today}/total`;
            
            // 2.1. Lee el contador (para mostrarlo)
            db.ref(viewPath).on('value', snap => {
                document.getElementById('view-counter').innerHTML = `<i class="fas fa-eye"></i> Vistas: ${snap.val() ? snap.val().toLocaleString() : 0}`;
            });

            // 2.2. Registra la visita (solo si es la primera vez en esta sesi√≥n)
            if (!sessionStorage.getItem('viewRegistered')) {
                db.ref(viewPath).transaction((currentTotal) => {
                    return (currentTotal || 0) + 1;
                });
                sessionStorage.setItem('viewRegistered', 'true');
            }
        }
        
        // 3. ENVIAR VOTO (LIKE/DISLIKE)
        function sendVote(type) {
            if (userVoteState) {
                alert(`Ya has votado (${userVoteState}) en esta sesi√≥n.`);
                return;
            }

            userVoteKey = new Date().getTime(); 
            const votePath = `${BASE_CIUDAD_PATH}${currentLocalityId}/votes/${userVoteKey}`;
            
            db.ref(votePath).set({
                type: type,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                alert(`‚úÖ Voto de ${type} registrado con √©xito.`);
                userVoteState = type;
            })
            .catch(error => {
                console.error("Error al registrar voto:", error);
                alert(`‚ùå Error al registrar voto. Verifica las reglas de Firebase.`);
            });
        }
        
        // 4. MODO OSCURO
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }


        // 5. CARGA DE DATOS PRINCIPAL
        async function loadReport() {
            getLocalityIdFromUrl();
            document.getElementById('page-title').textContent = `Asesor P√∫blico | ${currentLocalityId.replace('_', ' ').toUpperCase()}`;
            
            const reportContentDiv = document.getElementById('report-content');

            try {
                // Leer el JSON generado por el robot (con timestamp para evitar cach√©)
                const response = await fetch(`noticias_${currentLocalityId}.json?t=${new Date().getTime()}`);
                const data = await response.json();

                if (!data || !data.categorias) {
                    throw new Error("Estructura de informe inv√°lida o vac√≠a.");
                }

                // 5.1 Renderizar T√≠tulo y Metadata
                document.getElementById('main-title').textContent = data.title;
                document.getElementById('metadata').textContent = `Actualizado: ${new Date(data.last_updated).toLocaleString()}`;

                // 5.2 Renderizar Categor√≠as
                let html = '';
                data.categorias.forEach(cat => {
                    html += `
                        <div class="category">
                            <h2>${cat.nombre}</h2>
                            <p>${cat.contenido}</p>
                        </div>
                    `;
                });
                reportContentDiv.innerHTML = html;
                
                registerView(); // Llama a registrar y monitorear vistas
                
            } catch (error) {
                console.error("Error al cargar el informe:", error);
                reportContentDiv.innerHTML = `<p style="color:red;">No se pudo cargar el informe para **${currentLocalityId.toUpperCase()}**. Aseg√∫rate de que el robot haya sido ejecutado y el archivo noticias_${currentLocalityId}.json exista.</p>`;
            }
        }

        // Inicia la aplicaci√≥n al cargar
        window.onload = loadReport;
    </script>
</body>
</html>
