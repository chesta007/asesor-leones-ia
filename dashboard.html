<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Asesor P√∫blico Digital V2.0</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* CSS Base para Estilo GitHub/n8n */
        :root {
            --color-primary: #10b981; /* Verde Esmeralda */
            --color-error: #ef4444; 
            --color-bg-body: #0d1117; /* Fondo Oscuro GitHub */
            --color-bg-card: #161b22;
            --color-text-main: #c9d1d9;
            --color-border: #30363d;
            --font-family: 'Inter', sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-bg-body);
            color: var(--color-text-main);
            padding: 20px;
            margin: 0;
        }
        .container { max-width: 1200px; margin: 0 auto; }

        /* Estilos de Botones */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            margin-top: 10px;
            white-space: nowrap; 
        }
        .btn-google { background-color: #4285f4; color: white; }
        .btn-classic { background-color: var(--color-primary); color: white; width: 100%; }

        /* Dashboard y Navegaci√≥n (Estilo GitHub) */
        .header { border-bottom: 2px solid var(--color-border); padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Contenedor del T√≠tulo y Hora */
        .header-left {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        #current-time {
            font-size: 0.9em;
            color: #8b949e; 
        }
        
        .nav-tabs { display: flex; border-bottom: 1px solid var(--color-border); margin-bottom: 20px; }
        .nav-tab { padding: 10px 15px; cursor: pointer; color: var(--color-text-secondary); transition: color 0.2s, border-bottom 0.2s; }
        .nav-tab.active { color: white; border-bottom: 2px solid var(--color-primary); }
        .content-card { background-color: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: 6px; padding: 20px; margin-bottom: 20px; }
        
        /* Login Screen */
        #login-screen { text-align: center; max-width: 400px; margin: 100px auto; }
        #login-form input, .form-control {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            background-color: var(--color-bg-body);
            color: var(--color-text-main);
            box-sizing: border-box; 
        }
        .divider { margin: 20px 0; font-size: 0.9em; color: var(--color-text-secondary); }
        
        /* Contenido Oculto */
        #dashboard-content > div { display: none; }
        #dashboard-content > div.active { display: block; }
        
        /* Tarjetas de Estad√≠sticas */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .stat-box { padding: 15px; border-left: 5px solid var(--color-primary); background-color: #1a1f26; border-radius: 4px; }
        .stat-box h3 { margin-top: 0; font-size: 1em; color: var(--color-primary); }
        .stat-box p { font-size: 1.8em; font-weight: 900; margin: 5px 0 0; }

        /* Estilos de Tabla de Sponsors */
        .sponsors-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
        }
        .sponsors-table th, .sponsors-table td {
            border: 1px solid var(--color-border);
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
        }
        .status-al-dia { color: var(--color-primary); font-weight: 700; }
        .status-pendiente { color: var(--color-error); font-weight: 700; }
        
        #loading { text-align: center; padding: 50px; }

        /* Estilos espec√≠ficos para el Formulario de Creaci√≥n */
        .form-group label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        /* Estilos espec√≠ficos para los botones dentro de la tabla */
        .action-cell {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .action-cell .btn {
            padding: 5px 8px;
            font-size: 0.8em;
            margin: 0;
            margin-bottom: 5px; 
            width: auto;
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="loading">Cargando Dashboard...</div>
        
        <div id="login-screen" style="display:none;">
            <div class="content-card">
                <h2>Acceso de Gesti√≥n</h2>
                
                <form id="login-form">
                    <input type="email" id="email" placeholder="Correo Electr√≥nico" required>
                    <input type="password" id="password" placeholder="Contrase√±a" required>
                    <button type="submit" class="btn btn-classic">Iniciar Sesi√≥n</button>
                    <p id="login-error" style="color: var(--color-error); margin-top: 10px;"></p>
                </form>

                <div class="divider">‚Äî O ‚Äî</div>
                
                <p>Usa Google para acceso r√°pido:</p>
                <button id="google-login-btn" class="btn btn-google"><i class="fas fa-google"></i> Iniciar Sesi√≥n con Google</button>
            </div>
        </div>

        <div id="main-dashboard" style="display:none;">
            <div class="header">
                <div class="header-left">
                    <h1 id="welcome-message">Dashboard de Gesti√≥n</h1>
                    <p id="current-time">Cargando hora...</p>
                </div>
                <button id="logout-btn" class="btn btn-google" style="background-color: var(--color-error);">Cerrar Sesi√≥n</button>
            </div>

            <div class="nav-tabs">
                <div class="nav-tab active" data-tab="stats"><i class="fas fa-chart-line"></i> Estad√≠sticas</div>
                <div class="nav-tab" data-tab="localidades"><i class="fas fa-globe-americas"></i> Localidades</div>
                <div class="nav-tab admin-only" data-tab="creacion" style="display:none;"><i class="fas fa-plus-circle"></i> Crear Localidad</div>
            </div>

            <div id="dashboard-content">
                
                <div id="stats" class="active">
                    <div class="content-card">
                        <h2>Seleccionar Localidad y Opciones</h2>
                        <div style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 20px;">
                            <div class="form-group" style="flex: 1;">
                                <label for="localidad-selector">Localidad a Visualizar:</label>
                                <select id="localidad-selector" class="form-control"></select>
                            </div>
                            <div style="flex: 1;">
                                 <label for="comparar-selector">Comparar con (Visi√≥n Futura):</label>
                                <select id="comparar-selector" class="form-control" disabled>
                                    <option value="">No Comparar</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="content-card">
                        <h2 id="metricas-titulo">M√©tricas de la Plataforma Seleccionada</h2> 
                        <div class="stat-grid">
                            <div class="stat-box"><h3>Vistas de Hoy</h3><p id="stat-views">...</p></div>
                            <div class="stat-box"><h3>Likes Netos (Semana)</h3><p id="stat-likes">...</p></div>
                            <div class="stat-box"><h3>Sugerencias Pendientes</h3><p id="stat-sugs">...</p></div>
                            <button class="btn btn-classic" style="width: 100%; margin-top: 25px;" onclick="loadDashboardMetrics(document.getElementById('localidad-selector').value)">
                                <i class="fas fa-sync-alt"></i> Actualizar M√©tricas
                            </button>
                        </div>
                    </div>

                    <div class="content-card">
                        <h2>Reporte Semanal de la IA</h2>
                        <div id="ia-reporte">
                            <p>El reporte de an√°lisis de Gemini (Votos y Sugerencias) se cargar√° aqu√≠ cada lunes a las 9 AM.</p>
                        </div>
                    </div>
                </div>
                <div id="localidades">
                    <div class="content-card">
                        <h2>Localidades (Plataformas) Activas</h2>
                        <table class="sponsors-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Nombre P√∫blico</th>
                                    <th>ID de Firebase</th>
                                    <th>Pa√≠s/Provincia</th>
                                    <th>Fecha de Creaci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="localidades-table-body">
                                <tr><td colspan="5" style="text-align:center;">Cargando localidades...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="content-card">
                        <h2>Gesti√≥n de Sponsors y Contratos (Leones)</h2>
                        <table class="sponsors-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Contacto</th>
                                    <th>Vencimiento</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="sponsors-table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
                <div id="creacion">
                    <div class="content-card">
                        <h2>Creaci√≥n de Nueva Localidad y Escalabilidad</h2>
                        
                        <form id="form-crear-localidad">
                            <h3>Paso 1: Configuraci√≥n de Ubicaci√≥n</h3>
                            <p>Ingresa los detalles geogr√°ficos y la clave de identificaci√≥n √∫nica para la nueva plataforma.</p>
                            
                            <div class="form-group">
                                <label for="localidad-id">ID de Localidad √önico (Ej: `marcos_juarez`)</label>
                                <input type="text" id="localidad-id" class="form-control" placeholder="ID en min√∫sculas y sin espacios" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="localidad-pais">Pa√≠s</label>
                                <input type="text" id="localidad-pais" class="form-control" placeholder="Ej: Argentina" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="localidad-provincia">Provincia / Estado</label>
                                <input type="text" id="localidad-provincia" class="form-control" placeholder="Ej: C√≥rdoba" required>
                            </div>

                            <div class="form-group">
                                <label for="localidad-nombre-publico">Nombre P√∫blico de la Ciudad / Localidad</label>
                                <input type="text" id="localidad-nombre-publico" class="form-control" placeholder="Ej: Marcos Ju√°rez" required>
                            </div>

                            <h3 style="margin-top: 30px;">Paso 2: Duplicar Plataforma</h3>
                            <p>Al hacer clic, el sistema crear√° la estructura base de datos (`/id_localidad/`) utilizando los datos de la configuraci√≥n actual (Leones).</p>
                            
                            <button type="submit" class="btn btn-classic">
                                <i class="fas fa-copy"></i> Crear y Duplicar Plataforma
                            </button>
                        </form>
                    </div>
                </div>
                </div>
        </div>
    </div>

    <script>
        // --- CONSTANTES DE CONFIGURACI√ìN (TUS CLAVES) ---
        const FIREBASE_CONFIG = { 
            apiKey: "AIzaSyAPPXz2z0Eo72Sa9nIdwzvr7oVxOQpFs5w", 
            authDomain: "proyecto-asesor-publico.firebaseapp.com",
            databaseURL: "https://proyecto-asesor-publico-default-rtdb.firebaseio.com", 
            projectId: "proyecto-asesor-publico", 
        };
        // ‚ö†Ô∏è RUTA DE ROLES CR√çTICA (MAY√öSCULAS)
        const ADMIN_ROLES_PATH = 'ROLES/'; 

        // ‚ö†Ô∏è CONSTANTES DE RUTA ESCALABLE 
        const BASE_CIUDAD_PATH = 'PAISES/argentina/provincias/cordoba/ciudades/';
        const PATH_LEONES = BASE_CIUDAD_PATH + 'leones';
        
        // ‚ö†Ô∏è CONFIGURACI√ìN DE GITHUB ACTIONS
        const GITHUB_REPO_OWNER = 'chesta007'; // ‚¨ÖÔ∏è REEMPLAZAR con tu usuario de GitHub
        const GITHUB_REPO_NAME = 'asesor-leones-ia'; // ‚¨ÖÔ∏è REEMPLAZAR con tu repo
        const WORKFLOW_EVENT_TYPE = 'manual-update-city'; // Nombre del evento que definiremos en el YAML


        // Inicializaci√≥n de Firebase
        firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUserRole = 'VISUALIZADOR'; 

        // --- RELOJ DIGITAL EN TIEMPO REAL ---
        function updateTime() {
            const now = new Date();
            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' };
            const timeString = now.toLocaleTimeString('es-AR', options);
            document.getElementById('current-time').textContent = timeString;
        }
        setInterval(updateTime, 1000);
        
        // --- L√ìGICA DE AUTENTICACI√ìN (LOGIN/LOGOUT) ---
        
        // 1. Iniciar Login con Google
        document.getElementById('google-login-btn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .catch(error => {
                    document.getElementById('login-error').textContent = "Error de Login de Google. Verifica dominio autorizado.";
                    console.error("Error de Login:", error);
                });
        });

        // 2. Iniciar Login Cl√°sico (Email/Contrase√±a)
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    document.getElementById('login-error').textContent = "Error de Credenciales. Verifica Email y Contrase√±a.";
                    console.error("Error de Login Cl√°sico:", error);
                });
        });


        // 3. Cerrar Sesi√≥n
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => console.log("Sesi√≥n cerrada."));
        });
        
        // 4. Listener de Estado de Autenticaci√≥n
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-error').textContent = ""; 
                handleSuccessfulLogin(user);
            } else {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-dashboard').style.display = 'none';
                document.getElementById('login-screen').style.display = 'block';
                updateTime(); 
            }
        });

        // --- 5. GESTI√ìN DE ROLES Y BIENVENIDA ---
        function handleSuccessfulLogin(user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            const userEmailKey = user.email.toLowerCase().replace(/\./g, ','); 
            
            db.ref(ADMIN_ROLES_PATH + userEmailKey).once('value')
                .then(snapshot => {
                    const adminData = snapshot.val();
                    
                    if (adminData && adminData.rol) {
                        currentUserRole = adminData.rol;
                        
                        document.getElementById('welcome-message').textContent = `Hola, ${adminData.nombre} (${currentUserRole})`;
                        
                        if (currentUserRole === 'ADMIN') {
                            document.querySelector('.admin-only').style.display = 'block';
                        } else {
                            document.querySelector('.admin-only').style.display = 'none';
                        }
                        
                        loadDashboardMetrics(); 
                        
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('main-dashboard').style.display = 'block';
                    } else {
                        alert("Acceso denegado. Tu cuenta de Google/Email no est√° registrada como administrador del Dashboard.");
                        auth.signOut();
                    }
                });
        }
        
        // --- 6. CARGAR M√âTRICAS Y SPONSORS (RUTAS CORREGIDAS Y DIN√ÅMICAS) ---
        function loadDashboardMetrics(idLocalidad = 'leones') { 
             const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
             
             const metricasPath = BASE_CIUDAD_PATH + idLocalidad;
             
             // Cargar el t√≠tulo
             const selector = document.getElementById('localidad-selector');
             const selectedOption = selector.options[selector.selectedIndex];
             const nombrePublico = selectedOption ? selectedOption.text : 'Plataforma Seleccionada';
             document.getElementById('metricas-titulo').textContent = `M√©tricas de ${nombrePublico}`;


             // 6.1. Vistas de Hoy 
             db.ref(metricasPath + '/views/' + today + '/total').on('value', snap => {
                 document.getElementById('stat-views').textContent = snap.val() ? snap.val().toLocaleString() : '0';
             });

             // 6.2. Sugerencias Pendientes 
             db.ref(metricasPath + '/sugerencias/').once('value').then(snapshot => {
                 const count = snapshot.numChildren();
                 document.getElementById('stat-sugs').textContent = count;
             });

             // 6.3. Likes Netos (Simulaci√≥n)
             document.getElementById('stat-likes').textContent = '+150';

             loadSponsorsTable(); 
             
             // L√≥gica de Pesta√±as
             document.querySelectorAll('.nav-tab').forEach(tab => {
                 tab.addEventListener('click', function() {
                     document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                     this.classList.add('active');
                     
                     document.querySelectorAll('#dashboard-content > div').forEach(c => c.classList.remove('active'));
                     document.getElementById(this.dataset.tab).classList.add('active');
                 });
             });
        }
        
        // --- 7. CARGA DE TABLA DE SPONSORS (FASE 5) ---
        function loadSponsorsTable() {
            const tableBody = document.getElementById('sponsors-table-body');
            const sponsorsRef = db.ref('MONETIZACION/leones/sponsors'); 
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Cargando sponsors...</td></tr>';
            
            sponsorsRef.once('value').then(snapshot => {
                tableBody.innerHTML = ''; 
                const sponsors = snapshot.val();
                
                if (!sponsors) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No hay sponsors registrados para Leones.</td></tr>';
                    return;
                }

                Object.keys(sponsors).forEach(key => {
                    const sponsor = sponsors[key];
                    const statusClass = sponsor.estado_pago === 'AL DIA' ? 'status-al-dia' : 'status-pendiente';
                    
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${sponsor.nombre}</td>
                        <td>${sponsor.contacto}</td>
                        <td>${sponsor.vencimiento}</td>
                        <td class="${statusClass}">${sponsor.estado_pago}</td>
                    `;
                });
            }).catch(error => {
                console.error("Error cargando sponsors:", error);
                tableBody.innerHTML = '<tr><td colspan="4" style="color: var(--color-error); text-align:center;">Error al conectar con la base de datos de sponsors.</td></tr>';
            });
        }

        // --- FUNCIONES DE ACCI√ìN ---
        
        // Genera el link p√∫blico. Asumimos que la p√°gina principal es index.html en el mismo repositorio.
        function generatePublicLink(id) {
            const baseUrl = window.location.origin + window.location.pathname.replace('dashboard.html', 'index.html');
            return `${baseUrl}?localidad=${id}`;
        }

        function openPublicPage(id) {
            const link = generatePublicLink(id);
            window.open(link, '_blank');
        }

        function shareLocalidad(id) {
            const link = generatePublicLink(id);
            if (navigator.share) {
                navigator.share({
                    title: `P√°gina P√∫blica de ${id}`,
                    url: link,
                }).catch(error => console.log('Error compartiendo:', error));
            } else {
                navigator.clipboard.writeText(link).then(() => {
                    alert(`Enlace de ${id} copiado al portapapeles: ${link}`);
                });
            }
        }

        async function executeRobotUpdate(id) {
            // ‚ö†Ô∏è ADVERTENCIA DE SEGURIDAD: ESTA LLAMADA REQUIERE UN TOKEN SECRETO (PAT)
            // Para entornos p√∫blicos, este token DEBE SER MANEJADO POR UN SERVIDOR PROXY.
            
            // 1. Pedir Token al Usuario (Inseguro, solo para pruebas manuales)
            const GITHUB_TOKEN = prompt("Seguridad: Por favor, introduce tu Token de Acceso Personal (PAT) de GitHub para autorizar la actualizaci√≥n:"); 
            
            if (!GITHUB_TOKEN) {
                alert("Actualizaci√≥n cancelada. Se requiere el Token de Acceso Personal de GitHub (PAT).");
                return;
            }

            alert(`Activando el flujo de trabajo de GitHub Actions para ${id}...`);
            
            const dispatchUrl = `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/dispatches`;

            try {
                const response = await fetch(dispatchUrl, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Authorization': `token ${GITHUB_TOKEN}`, // ‚ö†Ô∏è MUY INSEGURO EN EL CLIENTE
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_type: WORKFLOW_EVENT_TYPE,
                        client_payload: {
                            locality_id: id, // Pasamos la ID de la localidad
                            updated_by: auth.currentUser ? auth.currentUser.email : 'dashboard_user'
                        }
                    })
                });

                if (response.status === 204) {
                    alert(`‚úÖ GitHub Actions iniciado con √©xito para ${id}. El robot Python se ejecutar√° en el servidor.`);
                } else {
                    const errorData = await response.json();
                    console.error("Error de GitHub:", errorData);
                    alert(`‚ùå Error al iniciar GitHub Actions (${response.status}). Verifica el PAT, el nombre del evento (${WORKFLOW_EVENT_TYPE}) y los permisos del Token. Mensaje: ${errorData.message}`);
                }
            } catch (error) {
                console.error("Error al conectar con GitHub:", error);
                alert(`‚ùå Error de red al intentar conectar con GitHub. Revisa tu conexi√≥n.`);
            }
        }
        
        function manageContracts(id) {
            alert(`Funcionalidad de Gesti√≥n de Contratos para ${id} (Pr√≥xima Fase).`);
        }

        // --- 9. CARGA DE TABLA DE LOCALIDADES (INCLUYE CARGA DE SELECTORES) ---
        function loadLocalidadesTable() {
            const tableBody = document.getElementById('localidades-table-body');
            const ciudadesRef = db.ref(BASE_CIUDAD_PATH); 
            const selector = document.getElementById('localidad-selector');

            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Cargando localidades...</td></tr>';
            selector.innerHTML = '';

            ciudadesRef.once('value').then(snapshot => {
                tableBody.innerHTML = ''; 
                const ciudades = snapshot.val();
                let isFirst = true;

                if (!ciudades) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay localidades registradas.</td></tr>';
                    return;
                }

                Object.keys(ciudades).forEach(id => {
                    const ciudad = ciudades[id].metadata;
                    
                    if (ciudad) {
                        // 1. Llenar la Tabla
                        const fecha = ciudad.fecha_creacion ? new Date(ciudad.fecha_creacion).toLocaleDateString() : 'N/A';
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>${ciudad.nombre_publico}</td>
                            <td>${id}</td>
                            <td>${ciudad.pais} / ${ciudad.provincia}</td>
                            <td>${fecha}</td>
                            <td class="action-cell">
                                <button class="btn btn-google" onclick="openPublicPage('${id}')">
                                    <i class="fas fa-external-link-alt"></i> Abrir P√°gina
                                </button>
                                <button class="btn btn-classic" onclick="executeRobotUpdate('${id}')">
                                    <i class="fas fa-robot"></i> Ejecutar Robot
                                </button>
                                <button class="btn btn-google" style="background-color: #007bff;" onclick="shareLocalidad('${id}')">
                                    <i class="fas fa-share-alt"></i> Compartir
                                </button>
                                <button class="btn btn-classic" style="background-color: #38a169;" onclick="manageContracts('${id}')">
                                    <i class="fas fa-edit"></i> Gestionar Contratos
                                </button>
                            </td>
                        `;
                        
                        // 2. Llenar el Selector de Estad√≠sticas
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = ciudad.nombre_publico;
                        selector.appendChild(option);

                        if (isFirst) {
                            selector.value = id;
                            isFirst = false;
                        }
                    }
                });

                // 3. Disparar la carga de m√©tricas para la primera localidad
                selector.removeEventListener('change', loadMetricsHandler); 
                selector.addEventListener('change', loadMetricsHandler);
                loadDashboardMetrics(selector.value); 
                
            }).catch(error => {
                console.error("Error cargando localidades:", error);
                tableBody.innerHTML = '<tr><td colspan="5" style="color: var(--color-error); text-align:center;">Error al conectar con el nodo de ciudades.</td></tr>';
            });
        }

        // Handler simplificado para el evento 'change' del selector
        function loadMetricsHandler() {
            loadDashboardMetrics(document.getElementById('localidad-selector').value);
        }

        // ------------------------------------------------------------------
        // üí• 8. L√ìGICA DE CREACI√ìN Y DUPLICACI√ìN DE LOCALIDAD
        // ------------------------------------------------------------------
        document.getElementById('form-crear-localidad').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('localidad-id').value.toLowerCase().replace(/ /g, '_');
            const pais = document.getElementById('localidad-pais').value;
            const provincia = document.getElementById('localidad-provincia').value;
            const nombrePublico = document.getElementById('localidad-nombre-publico').value;
            
            if (id === 'leones') {
                alert("Error: El ID 'leones' ya existe. Por favor, elige un ID √∫nico.");
                return;
            }

            if (!confirm(`¬øEst√°s seguro de crear la nueva localidad '${nombrePublico}' (ID: ${id}) duplicando la estructura de la plataforma 'leones'?`)) {
                return;
            }

            try {
                // 1. Obtener la estructura completa de la localidad 'leones' 
                const leonesSnapshot = await db.ref(PATH_LEONES).once('value');
                const leonesData = leonesSnapshot.val();

                if (!leonesData) {
                    alert(`Error: No se pudo encontrar la estructura base de 'leones' para duplicar en la ruta ${PATH_LEONES}.`);
                    return;
                }

                // 2. Definir la ruta de destino 
                const newLocalidadPath = BASE_CIUDAD_PATH + id;

                // 3. Comprobar si la nueva ruta ya existe 
                const newLocalidadCheck = await db.ref(newLocalidadPath).once('value');
                if (newLocalidadCheck.exists()) {
                    alert(`Error: La ruta de la base de datos /${newLocalidadPath} ya existe. Por favor, elige un ID √∫nico.`);
                    return;
                }

                // 4. Escribir la estructura de 'leones' en la nueva ruta (copia) 
                await db.ref(newLocalidadPath).set(leonesData);

                // 5. Actualizar los metadatos de la nueva estructura creada 
                await db.ref(newLocalidadPath + '/metadata').set({
                    id: id,
                    nombre_publico: nombrePublico,
                    pais: pais,
                    provincia: provincia,
                    fecha_creacion: new Date().toISOString()
                });
                
                alert(`¬°√âxito! La localidad "${nombrePublico}" (ID: ${id}) ha sido creada. Estructura duplicada en la ruta /${newLocalidadPath}.`);
                document.getElementById('form-crear-localidad').reset(); 

                // Recargar la tabla y el selector
                loadLocalidadesTable();

            } catch (error) {
                console.error("Error cr√≠tico al duplicar la estructura de la BD:", error);
                alert("Error cr√≠tico al duplicar la estructura. Revisa la consola para m√°s detalles.");
            }
        });
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
</body>
</html>
